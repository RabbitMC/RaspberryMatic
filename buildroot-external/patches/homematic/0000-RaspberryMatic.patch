--- homematic/arm-gnueabihf/packages-eQ-3/HS485D/etc/init.d/S49hs485d.orig
+++ homematic/arm-gnueabihf/packages-eQ-3/HS485D/etc/init.d/S49hs485d
@@ -11,9 +11,12 @@
 
 CFG_TEMPLATE_DIR=/etc/config_templates
 
-init() {
-	export TZ=`cat /etc/config/TZ`
+source /var/hm_mode 2>/dev/null
+
+# skip this startup in LAN Gateway mode
+[[ ${HM_MODE} == "HMLGW" ]] && exit 0
 
+init() {
 	if [ ! -d /etc/config/hs485d ] ; then
   		mkdir /etc/config/hs485d
 	fi
@@ -25,17 +28,29 @@
 	else
 		cmp -s $CFG_TEMPLATE_DIR/InterfacesList.xml /etc/config/InterfacesList.xml || cp $CFG_TEMPLATE_DIR/InterfacesList.xml /etc/config
 	fi
+
+  # if there is no HmIP support enabled we have to strip
+  # the HmIP-RF part in InterfacesList.xml
+  if [[ ${HM_MODE} != "HmIP" ]] || [[ -z $(cat /var/rf_address) ]]; then
+    line_start=$(cat /etc/config/InterfacesList.xml | grep -n '>HmIP-RF<' | cut -d: -f1 | head -1)
+    line_end=$(cat /etc/config/InterfacesList.xml | grep -n '>HmIP-RF<' | cut -d: -f1 | tail -1)
+    if [[ -n ${line_start} && -n ${line_end} ]]; then
+      line_start=$((${line_start}-1))
+      line_end=$((${line_end}+1))
+      sed -i "${line_start},${line_end}d" /etc/config/InterfacesList.xml
+    fi
+  fi
 }
 
 start() {
-	echo -n "Preparing start of hs485d"
+	echo -n "Preparing start of hs485d: "
 	init
 	/bin/hs485dLoader -l $LOGLEVEL_HS485D -ds -dd /etc/config/hs485d.conf
 	echo "OK"
 }
 
 stop() {
-	echo "OK"
+	echo -n ""
 }
 
 restart() {
@@ -59,4 +74,3 @@
 esac
 
 exit $?
-
--- homematic/arm-gnueabihf/packages-eQ-3/HS485D/etc/init.d/S60hs485d.orig
+++ homematic/arm-gnueabihf/packages-eQ-3/HS485D/etc/init.d/S60hs485d
@@ -7,9 +7,12 @@
 
 CFG_TEMPLATE_DIR=/etc/config_templates
 
-init() {
-	export TZ=`cat /etc/config/TZ`
+source /var/hm_mode 2>/dev/null
+
+# skip this startup in LAN Gateway mode
+[[ ${HM_MODE} == "HMLGW" ]] && exit 0
 
+init() {
 	if [ ! -e /etc/config/syslog ] ; then
 		cp $CFG_TEMPLATE_DIR/syslog /etc/config
 	fi
--- homematic/arm-gnueabihf/packages-eQ-3/RFD/etc/config_templates/rfd.conf.orig
+++ homematic/arm-gnueabihf/packages-eQ-3/RFD/etc/config_templates/rfd.conf
@@ -22,6 +22,5 @@
 [Interface 0]
 Type = CCU2
 ComPortFile = /dev/mmd_bidcos
-#AccessFile = /dev/null
-#ResetFile = /dev/ccu2-ic200
-
+AccessFile = /dev/null
+ResetFile = /dev/null
--- homematic/arm-gnueabihf/packages-eQ-3/RFD/etc/init.d/S60multimacd.orig
+++ homematic/arm-gnueabihf/packages-eQ-3/RFD/etc/init.d/S60multimacd
@@ -7,44 +7,20 @@
 CFG_TEMPLATE_DIR=/etc/config_templates
 PIDFILE=/var/run/multimacd.pid
 
-update() {        
-	if [ ! -e /etc/config/no-coprocessor-update ] ; then
-		echo "checking if firmware update is needed..."
-		/bin/eq3configcmd update-coprocessor -p "/dev/mxs_auart_raw.0" -u
-		if ! [ $? -eq 0 ] ; then
-			echo "error while updating coprocessor, recovering..."
-			avrprog --bo
-			/bin/eq3configcmd update-coprocessor -p "/dev/mxs_auart_raw.0" -u -f
-			sleep 1
-		else
-			echo "done"
-			sleep 1
-		fi
-	else
-		echo "firmware update disabled"
-	fi
-}
-check_bo(){
-	avrprog --devinfo | grep -q ec,fd,da,ef
-	if ! [ 0 -eq $? ];
-	then
-	avrprog --bo
-	fi
-}
-check_rf_address(){
-        sed 1q /sys/module/plat_eq3ccu2/parameters/radio_mac > /var/log/rf_address
-        /bin/eq3configcmd read-default-rf-address -l 0 -v -h -f /dev/mxs_auart_raw.0 | grep -q -F -f /var/log/rf_address
-        if ! [ 0 -eq $? ];
-        then
-        avrprog --bo
-        fi
-        rm /var/log/rf_address
-}
+source /var/hm_mode 2>/dev/null
+
+# skip this startup in LAN Gateway mode
+[[ ${HM_MODE} == "HMLGW" ]] && exit 0
+
 init() {
-	export TZ=`cat /etc/config/TZ`
-	
-	if [ ! -e /etc/config/multimacd.conf ] ; then
-		cp $CFG_TEMPLATE_DIR/multimacd.conf /etc/config
+
+  # make sure there is no /dev/ttyS0
+  if [ -e /dev/ttyS0 ] ; then
+    rm -f /dev/ttyS0
+  fi
+
+	if [ ! -e /var/etc/multimacd.conf ] ; then
+		cp $CFG_TEMPLATE_DIR/multimacd.conf /var/etc/
 	fi
 
 	if [ ! -e /etc/config/syslog ] ; then
@@ -57,44 +33,41 @@
 }
 
 waitStartupComplete() {
-    echo -n "Waiting for multimacd to get ready"
 	STEPS=5
     for i in $(seq 1 $STEPS)
     do
 		sleep 2
 		echo -n "."
-        MMDSTATUSPID=`cat /var/status/multimacd.status 2>/dev/null`
+        MMDSTATUSPID=`cat /var/status/multimacd.status 2>&1`
         MMDPID=`pidof multimacd`
-        if [ $MMDSTATUSPID = $MMDPID ] 
+        if [ "$MMDSTATUSPID" = "$MMDPID" ] 
 		then
-            echo "multimacd is ready now."
+            echo "OK"
             break
 		fi 
         if [ $i -eq $STEPS ]
 		then
-            echo "Timeout while waiting for multimacd to get ready."
+            echo "ERROR"
         fi
     done
 }
 
 start() {
-	echo "Starting multimacd: "
-	init
-	if [ ! -e $PIDFILE ] ; then
-		check_bo
-                check_rf_address
-		update
-	else
-		echo "Skipping coprocessor update because multimacd is running."
-	fi
-	init
-	start-stop-daemon -S -q -b -m -p $PIDFILE --exec /bin/multimacd -- -f /etc/config/multimacd.conf -l $LOGLEVEL_RFD
-	waitStartupComplete
+	echo -n "Starting multimacd: "
+  if [[ ${HM_MODE} == "HmIP" ]] && [[ ! -z $(cat /var/rf_address) ]]; then
+	  init
+	  start-stop-daemon -S -N -10 -q -b -m -p $PIDFILE --exec /bin/multimacd -- -f /var/etc/multimacd.conf -l $LOGLEVEL_RFD
+	  waitStartupComplete
+  else
+    echo "not required"
+  fi
 }
 stop() {
 	echo -n "Stopping multimacd: "
-	start-stop-daemon -K -q -p $PIDFILE
-	rm -f $PIDFILE
+  if [[ ${HM_MODE} == "HmIP" ]] && [[ ! -z $(cat /var/rf_address) ]]; then
+	  start-stop-daemon -K -q -p $PIDFILE
+	  rm -f $PIDFILE
+  fi
 	echo "OK"
 }
 restart() {
--- homematic/arm-gnueabihf/packages-eQ-3/RFD/etc/init.d/S61rfd.orig
+++ homematic/arm-gnueabihf/packages-eQ-3/RFD/etc/init.d/S61rfd
@@ -7,30 +7,42 @@
 CFG_TEMPLATE_DIR=/etc/config_templates
 PIDFILE=/var/run/rfd.pid
 
+source /var/hm_mode 2>/dev/null
+
+# skip this startup in LAN Gateway mode
+[[ ${HM_MODE} == "HMLGW" ]] && exit 0
+
 init() {
-	export TZ=`cat /etc/config/TZ`
 
 	if [ ! -d /etc/config/rfd ] ; then
   		mkdir /etc/config/rfd
 	fi
+
 	#Migration for existing rfd.conf in user space
 	if [ ! -e /etc/config/rfd.conf ] ; then
-		cp $CFG_TEMPLATE_DIR/rfd.conf /etc/config
-	else
-		sed -i 's/\/dev\/ttyAPP0/\/dev\/mmd_bidcos/' /etc/config/rfd.conf || true
-		sed -i 's/^AccessFile/#AccessFile/' /etc/config/rfd.conf || true
-		sed -i 's/^ResetFile/#ResetFile/' /etc/config/rfd.conf || true
-                if ! grep -q "Improved Coprocessor Initialization" /etc/config/rfd.conf ; then
-                        sed -i 's/\[Interface 0\]/Improved\ Coprocessor\ Initialization\ =\ true\n\n&/' /etc/config/rfd.conf || true
-                fi
-	fi
+		cp $CFG_TEMPLATE_DIR/rfd.conf /etc/config/rfd.conf
+  fi
 
-        # Bug fix
-        grep "/etc/config/rfd/keys" /etc/config/rfd.conf
-        if [ $? == 0 ] ; then
-                echo "Copy rfd files"
-		cp $CFG_TEMPLATE_DIR/rfd.conf /etc/config
-        fi
+  # only modify if real rf module found
+  if [[ ! -z $(cat /var/rf_address) ]]; then
+    # make sure [Interface 0] is uncommented
+    sed -i -e '/^#\[Interface 0\]/,/^#\s*$/ s/^#//' /etc/config/rfd.conf
+
+    # patch some settings to match what this hardware expects.
+    if [[ ${HM_MODE} == "HmIP" ]]; then
+      sed -i 's/^ComPortFile = \/dev\/.*$/ComPortFile = \/dev\/mmd_bidcos/' /etc/config/rfd.conf
+    else
+      sed -i 's/^ComPortFile = \/dev\/.*$/ComPortFile = \/dev\/ttyAMA0/' /etc/config/rfd.conf
+    fi
+    sed -i 's/^#*AccessFile = \/dev\/.*$/AccessFile = \/dev\/null/' /etc/config/rfd.conf
+    sed -i 's/^#*ResetFile = \/dev\/.*$/ResetFile = \/dev\/null/' /etc/config/rfd.conf
+    if ! grep -q "Improved Coprocessor Initialization" /etc/config/rfd.conf ; then
+      sed -i 's/\[Interface 0\]/Improved\ Coprocessor\ Initialization\ =\ true\n\n&/' /etc/config/rfd.conf
+    fi
+  else
+    # otherwise disable the whole [Interface 0] part
+    sed -i -e '/^\[Interface 0\]/,/^\s*$/ s/^/#/' /etc/config/rfd.conf
+  fi
 
 	if [ ! -e /etc/config/syslog ] ; then
 		cp $CFG_TEMPLATE_DIR/syslog /etc/config
@@ -42,28 +54,27 @@
 }
 
 waitStartupComplete() {
-    echo -n "Waiting for rfd to get ready"
-	STEPS=60
+	STEPS=20
     for i in $(seq 1 $STEPS)
     do
 		sleep 2
 		echo -n "."
-        RFDSTATUSPID=`cat /var/status/rfd.status 2>/dev/null`
+        RFDSTATUSPID=`cat /var/status/rfd.status 2>&1`
         RFDPID=`pidof rfd`
-        if [ $RFDSTATUSPID = $RFDPID ] 
+        if [ "$RFDSTATUSPID" = "$RFDPID" ] 
 		then
-            echo "rfd is ready now."
+            echo "OK"
             break
         fi
         if [ $i -eq $STEPS ] 
 		then
-            echo "Timeout while waiting for rfd to get ready."
+            echo "ERROR"
         fi
     done
 }
 
 start() {
-	echo "Starting rfd: "
+	echo -n "Starting rfd: "
 	init
 	start-stop-daemon -S -q -b -m -p $PIDFILE --exec /bin/rfd -- -f /etc/config/rfd.conf -l $LOGLEVEL_RFD
 	waitStartupComplete
--- homematic/arm-gnueabihf/packages-eQ-3/WebUI/etc/rega.conf.orig
+++ homematic/arm-gnueabihf/packages-eQ-3/WebUI/etc/rega.conf
@@ -57,6 +57,26 @@
 # Standard: 300
 SessionTimeout=300
 
+# SessionMaxCount
+# Maximale Anzahl paralleler Sessions.
+# Standard: 3
+SessionMaxCount=10
+
+# AutoSaveDOMCycle
+# Intervalzeit in Sekunden für das automatisch Speichern der Konfiguration
+# Standard: 43200 (12h)
+AutoSaveDOMCycle=43200
+
+# AutoSaveDOMOnExit
+# Wenn gesetzt wird beim beenden erzwungen das die DOM Konfiguration in gespeichert wird
+# Standard: 0 (false)
+AutoSaveDOMOnExit=0
+
+# CheckModifiedCycle
+# Intervalzeit in Sekunden für das Prüfen+Speichern bei Konfigänderungen
+# Standard: 600 (10min)
+CheckModifiedCycle=600
+
 #*******************************************************************************
 # Ereignisse
 #*******************************************************************************
--- homematic/arm-gnueabihf/packages/lighttpd/etc/lighttpd/conf.d/cgi.conf.orig
+++ homematic/arm-gnueabihf/packages/lighttpd/etc/lighttpd/conf.d/cgi.conf
@@ -1,5 +1,7 @@
 #### CGI module
 cgi.assign = ( ".pl"  => "/usr/bin/perl",
-                ".cgi" => "/opt/hm/bin/tclsh",
+                ".cgi" => "/bin/tclsh",
                 ".ccc" => ""
              )
+cgi.x-sendfile = "enable"
+cgi.x-sendfile-docroot = ( "/usr/local/tmp" )
--- homematic/arm-gnueabihf/packages/lighttpd/etc/lighttpd/conf.d/setenv.conf.orig
+++ homematic/arm-gnueabihf/packages/lighttpd/etc/lighttpd/conf.d/setenv.conf
@@ -1,3 +1,3 @@
 setenv.add-environment = (
-        "TZ" => "CET-1CEST-2,M3.5.0/02:00:00,M10.5.0/03:00:00"
+        "EQ3_OS_PLATFORM" => "HM-RASPBERRYMATIC"
 )
--- homematic/arm-gnueabihf/packages/lighttpd/etc/lighttpd/lighttpd.conf.orig
+++ homematic/arm-gnueabihf/packages/lighttpd/etc/lighttpd/lighttpd.conf
@@ -14,10 +14,10 @@
 ## chroot example aswell.
 ##
 var.log_root    = "/var/log"
-var.server_root = "/opt/hm/www"
+var.server_root = "/www/"
 var.state_dir   = "/var/run"
 var.home_dir    = "/var/lib/lighttpd"
-var.conf_dir    = "/opt/hm/etc/lighttpd"
+var.conf_dir    = "/etc/lighttpd"
 
 ## 
 ## run the server chrooted.
@@ -87,6 +87,33 @@
 ##
 server.port = 80
 
+$SERVER["socket"] == ":8181" {
+	server.document-root = server_root
+}
+
+$SERVER["socket"] == ":443" {
+	server.document-root = server_root
+	ssl.engine = "enable"
+	ssl.pemfile = "/etc/config/server.pem"
+}
+
+$SERVER["socket"] == "[::]:80" {
+	server.document-root = server_root
+	server.use-ipv6 = "enable"
+}
+
+$SERVER["socket"] == "[::]:8181" {
+	server.document-root = server_root
+	server.use-ipv6 = "enable"
+}
+
+$SERVER["socket"] == "[::]:443" {
+	server.document-root = server_root
+	ssl.engine = "enable"
+	ssl.pemfile = "/etc/config/server.pem"
+	server.use-ipv6 = "enable"
+}
+
 ##
 ## Use IPv6?
 ##
@@ -127,6 +154,11 @@
 server.pid-file = state_dir + "/lighttpd.pid"
 
 ##
+## number of worker processes to spawn.
+##
+server.max-worker = 4
+
+##
 #######################################################################
 
 #######################################################################
@@ -230,14 +262,14 @@
 ##
 ## Default: 5
 ##
-#server.max-keep-alive-idle = 5
+server.max-keep-alive-idle = 60
 
 ##
 ## How many keep-alive requests until closing the connection.
 ##
 ## Default: 16
 ##
-#server.max-keep-alive-requests = 16
+server.max-keep-alive-requests = 50
 
 ##
 ## Maximum size of a request in kilobytes.
@@ -252,14 +284,14 @@
 ##
 ## Default: 60
 ##
-#server.max-read-idle = 60
+server.max-read-idle = 600
 
 ##
 ## Time to write to a socket before we consider it idle.
 ##
 ## Default: 360
 ##
-#server.max-write-idle = 360
+server.max-write-idle = 600
 
 ##
 ##  Traffic Shaping 
@@ -370,7 +402,12 @@
 ##
 ## defaults to /var/tmp as we assume it is a local harddisk
 ##
-server.upload-dirs = ( "/var/tmp" )
+server.upload-dirs = ( "/usr/local/tmp" )
+
+##
+## default size of temp files
+##
+server.upload-temp-file-size = 16777216
 
 ##
 #######################################################################
@@ -440,6 +477,6 @@
 ## custom includes like vhosts.
 ##
 #include "conf.d/config.conf"
-#include_shell "cat /etc/lighttpd/vhosts.d/*.conf"
+include_shell "test -d /etc/config/lighttpd && cat /etc/config/lighttpd/*.conf"
 ##
 #######################################################################
--- homematic/firmware/HM-MOD-UART/fwmap.orig
+++ homematic/firmware/HM-MOD-UART/fwmap
@@ -1,7 +1,7 @@
 #Type           Filename                Version
 
 #Coprozessor
-CCU2                    coprocessor_update.eq3                          1.4.1          #CoProzessor CCU2  (HM-MOD-UART)
+#CCU2                    coprocessor_update.eq3                          1.4.1          #CoProzessor CCU2  (HM-MOD-UART)
 
-#CCU2					dualcopro_si1002_update_blhm.eq3				2.8.5		   #Dual CoProzessor CCU2
+CCU2					dualcopro_si1002_update_blhm.eq3				2.8.5		   #Dual CoProzessor CCU2
 
--- homematic/HMserver/opt/HMServer/pages/StorageSettingsDialog.ftl.orig
+++ homematic/HMserver/opt/HMServer/pages/StorageSettingsDialog.ftl
@@ -161,38 +161,6 @@
 <div class="CLASS21114 j_translate">
 	<table class="popupTable" border=1 width="100%">
 		<tr class="CLASS21115">
-			<td class="CLASS21116">${"$"}{dialogSettingsSDCardSettings}</td>
-			<td  align="center"  width="35%">
-				<table>
-					<tr>
-						<td class="CLASS21112">${"$"}{dialogSettingsSDCardStatus}:</td>
-						<td>${SDCardStatus}</td>
-					</tr>
-					<tr>
-						<td align="center" class="CLASS21112" colspan="2" >
-							<div class="popupControls CLASS21107">
-								<table>
-								<tr>
-									<td align="right">
-										<div id="initaliseSDCardButton" class="StdButton CLASS04907" onClick="OnInitaliseSDCard()">${"$"}{dialogSettingsStorageSettingsBtnInitaliseSDCard}</div>
-									</td>
-									<td align="right">
-										<div id="backupSDCardButton" class="StdButton CLASS04907" onClick="OnBackupSDCard()">${"$"}{dialogSettingsStorageSettingsBtnBackup}</div>
-									</td>
-								</tr>
-								</table>
-							</div>
-								<!--<div id="ejectSDCardButton" class="StdButton" onClick="OnEjectSDCard()">${"$"}{dialogSettingsStorageSettingsBtnEjectSDCard}</div> -->
-						</td>
-					</tr>
-				</table>
-			</td>
-			<td class="CLASS21113" align="left">
-				<p> ${"$"}{dialogSettingsStorageHintSDCardP1} </p>
-				<p> ${"$"}{dialogSettingsStorageHintSDCardP2} </p>
-			</td>
-		</tr>
-		<tr class="CLASS21115">
 		  <td class="CLASS21116">
        ${"$"}{tdPowerCost}
 		  </td>
--- homematic/WebUI/bin/hm_autoconf.orig
+++ homematic/WebUI/bin/hm_autoconf
@@ -74,6 +74,7 @@
     # Mapping of channel type to default function for the channel
     array set CHANNEL_FUNCTIONS {
         BLIND                   LIGHT
+        JALOUSIE                LIGHT
         DIMMER                  LIGHT
         VIRTUAL_DIMMER          LIGHT
         KEYMATIC                LOCK
@@ -545,61 +546,69 @@
         set FUNCTIONMAP([lindex $FUNCTIONLIST $i]) $function_id
         incr i 2
     }
-    
-    foreach ise_dev_id [array names devmap] {
-        set dev $devmap($ise_dev_id)
-        set dev_address [lindex $dev 0]
-        set if_id [lindex $dev 1]
-        array_clear channels
-        array set channels [lindex $dev 2]
-        set if_info $ifmap($if_id)
-        set url [lindex $if_info 0]
-        
-        array_clear dev_descr
-        array set dev_descr [xmlrpc $url getDeviceDescription $dev_address]
-        set procname "conf_device_$dev_descr(TYPE)"
-        if {[llength [info procs $procname]]} {
-            if [catch { $procname $url $ise_dev_id dev_descr } errMsg] {
-                puts "$procname $errMsg"
-            }
-        }
-        
-        foreach ise_ch_id [array names channels] {
-            set ch_address $channels($ise_ch_id)
-            array_clear ch_descr
-            array set ch_descr [xmlrpc $url getDeviceDescription $ch_address]
-            if [info exist DEVICE_FUNCTIONS($dev_descr(TYPE))] {
-                catch {
-                    rega "dom.GetObject($FUNCTIONMAP($DEVICE_FUNCTIONS($dev_descr(TYPE)))).Add($ise_ch_id)"
-                }
-            }
-            if [info exist CHANNEL_FUNCTIONS($ch_descr(TYPE))] {
-                catch {
-                    rega "dom.GetObject($FUNCTIONMAP($CHANNEL_FUNCTIONS($ch_descr(TYPE)))).Add($ise_ch_id)"
-                }
-            }
-            set procname "conf_channel_$ch_descr(TYPE)"
-            if {[llength [info procs $procname]]} {
-                if [catch { $procname $url $ise_ch_id ch_descr } errMsg] {
-                    puts "$procname $errMsg"
-                }
-            }
-            if {[llength [info procs "conf_value_$ch_descr(TYPE).*"]]} {
-                array_clear values_descr
-                array set values_descr [xmlrpc $url getParamsetDescription $ch_address "VALUES"]
-                foreach value [array names values_descr] {
-                    set procname "conf_value_$ch_descr(TYPE).$value"
-                    if {[llength [info procs $procname]]} {
-                        array set value_descr $values_descr($value)
-                        if [catch { $procname $url $ise_ch_id ch_descr value_descr } errMsg] {
-                            puts "$procname $errMsg"
-                        }
-                    }
-                }
-            }
-        }
-        rega "dom.GetObject($ise_dev_id).AddMetaData(\"AUTOCONF\");"
-    
+
+    # We need a catch because OSRAM Lightify causes an error (/tmp/hm_autoconf_xxx.log) because a list must have an even number of elements.
+    # set dev $devmap($ise_dev_id) produces something like that:
+    # OL-SurfaceTW 0 1008 { 19913 OL-SurfaceTW 0:0 19914 OL-SurfaceTW 0:1}
+    #
+    # It has to be like this:
+    # JEQ0067507 1007 { 1655 JEQ0067507:1}
+    catch {
+      foreach ise_dev_id [array names devmap] {
+          set dev $devmap($ise_dev_id)
+          set dev_address [lindex $dev 0]
+          set if_id [lindex $dev 1]
+          array_clear channels
+          array set channels [lindex $dev 2]
+          set if_info $ifmap($if_id)
+          set url [lindex $if_info 0]
+
+          array_clear dev_descr
+          array set dev_descr [xmlrpc $url getDeviceDescription $dev_address]
+          set procname "conf_device_$dev_descr(TYPE)"
+          if {[llength [info procs $procname]]} {
+              if [catch { $procname $url $ise_dev_id dev_descr } errMsg] {
+                  puts "$procname $errMsg"
+              }
+          }
+
+          foreach ise_ch_id [array names channels] {
+              set ch_address $channels($ise_ch_id)
+              array_clear ch_descr
+              array set ch_descr [xmlrpc $url getDeviceDescription $ch_address]
+              if [info exist DEVICE_FUNCTIONS($dev_descr(TYPE))] {
+                  catch {
+                      rega "dom.GetObject($FUNCTIONMAP($DEVICE_FUNCTIONS($dev_descr(TYPE)))).Add($ise_ch_id)"
+                  }
+              }
+              if [info exist CHANNEL_FUNCTIONS($ch_descr(TYPE))] {
+                  catch {
+                      rega "dom.GetObject($FUNCTIONMAP($CHANNEL_FUNCTIONS($ch_descr(TYPE)))).Add($ise_ch_id)"
+                  }
+              }
+              set procname "conf_channel_$ch_descr(TYPE)"
+              if {[llength [info procs $procname]]} {
+                  if [catch { $procname $url $ise_ch_id ch_descr } errMsg] {
+                      puts "$procname $errMsg"
+                  }
+              }
+              if {[llength [info procs "conf_value_$ch_descr(TYPE).*"]]} {
+                  array_clear values_descr
+                  array set values_descr [xmlrpc $url getParamsetDescription $ch_address "VALUES"]
+                  foreach value [array names values_descr] {
+                      set procname "conf_value_$ch_descr(TYPE).$value"
+                      if {[llength [info procs $procname]]} {
+                          array set value_descr $values_descr($value)
+                          if [catch { $procname $url $ise_ch_id ch_descr value_descr } errMsg] {
+                              puts "$procname $errMsg"
+                          }
+                      }
+                  }
+              }
+          }
+          rega "dom.GetObject($ise_dev_id).AddMetaData(\"AUTOCONF\");"
+
+      }
     }
 } errorMsg ]} {
     puts "Error: $errorMsg"
--- homematic/WebUI/www/api/homematic.cgi.orig
+++ homematic/WebUI/www/api/homematic.cgi
@@ -22,15 +22,13 @@
 # um eine Notlösung. 
 ##
 
-set central true
+set central true 
 
 # Zentrale oder Konfigtool (/www/ = Zentrale)
 if {$env(DOCUMENT_ROOT) != "\/www\/"} then {
   set central false
 }
 
-set central true
-
 #####################
 # Verwendete Module #
 #####################
--- homematic/WebUI/www/api/methods/ccu/setsshpassword.tcl.orig
+++ homematic/WebUI/www/api/methods/ccu/setsshpassword.tcl
@@ -9,9 +9,7 @@
 ##
 
 
-  package require md5crypt
-
-  set digest [md5crypt::md5crypt $args(passwd) [md5crypt::salt]]
+  set digest [exec echo "$args(passwd)" | mkpasswd -m sha512]
   set command "s%^root:\\(\[^:\]*:\\)%root:$digest:%"
   set rc [catch {exec sed -i "$command" /etc/config/shadow} msg]
 
--- homematic/WebUI/www/api/methods.conf.orig
+++ homematic/WebUI/www/api/methods.conf
@@ -988,6 +988,13 @@
         ARGUMENTS {_session_id_}
 }
 
+User.createCertificate {
+        LEVEL ADMIN
+        SCRIPT_FILE user/createcertificate.tcl
+        INFO {Generiert ein neues Zertifikat (server.pem) unter /etc/config}
+        ARGUMENTS {_session_id_ country hostname email serial}
+}
+
 User.restartLighttpd {
         LEVEL ADMIN
         SCRIPT_FILE user/restartlighttpd.tcl
@@ -1006,4 +1013,4 @@
         SCRIPT_FILE diagram/getDataSourceGroups.tcl
         INFO {Ermittelt alle bekannten Gruppen von Datenquellen}
         ARGUMENTS {}
-}
\ No newline at end of file
+}
--- homematic/WebUI/www/api/methods/user/createcertificate.tcl.orig
+++ homematic/WebUI/www/api/methods/user/createcertificate.tcl
@@ -0,0 +1,22 @@
+##
+# User.createCertificate
+# Erstellt ein neues Zertifikat unter /etc/config/server.pem
+#
+# Parameter:
+#   country  : [string] Landeskuerzel (z.B. DE)
+#   hostname : [string] Der CN Hostname der eintragen werden soll
+#   email    : [string] EMail-Adresse die eingetragen werden soll
+#   serial   : [string] Die Seriennummer der CCU
+##
+
+if { $args(hostname) != "" } then {
+  # Zertifikat erzeugen
+  exec /usr/bin/openssl req -new -x509 -nodes -keyout /etc/config/server.pem \
+                                              -out /etc/config/server.pem \
+                                              -days 3650 \
+                                              -subj "/C=$args(country)/emailAddress=$args(email)/O=HomeMatic/OU=$args(serial)/CN=$args(hostname)" 2>/dev/null >/dev/null
+
+  jsonrpc_response true
+} else {
+  jsonrpc_response false
+}
--- homematic/WebUI/www/config/control_panel.cgi.orig
+++ homematic/WebUI/www/config/control_panel.cgi
@@ -182,10 +182,9 @@
 set i 1
 
 if { "[read_var /etc/config/tweaks CP_DEVCONFIG]" != "" } {
-  puts "<!-- devconfig -->"
-  puts "<td>"
+  puts "<td><div class=\"cpButton\">"
   puts "<div class=\"StdTableBtn CLASS21701\" onclick=\"window.open('/tools/devconfig.cgi?sid=$sid');\">devconfig</div>"
-  puts "</td><td class=\"StdTableBtnHelp\"></td>"
+  puts "<div class=\"StdTableBtnHelp\"></div></td>"
   incr i
 }
 
--- homematic/WebUI/www/config/cp_maintenance.cgi.orig
+++ homematic/WebUI/www/config/cp_maintenance.cgi
@@ -221,7 +221,7 @@
 
 proc action_firmware_update_go {} {
     global env
-    cd /tmp/
+    cd /usr/local/tmp/
     
     http_head
 
@@ -259,8 +259,8 @@
 
 proc action_firmware_update_cancel {} {
   global env
-  catch {exec rm /var/new_firmware.tar.gz}
-  catch { exec /bin/sh -c "rm /var/EULA.*"}
+  catch {exec /bin/sh -c "rm -f /usr/local/tmp/*-*.img*"}
+  #catch {exec /bin/sh -c "rm /var/EULA.*"}
   cgi_javascript {
     puts "var url = \"$env(SCRIPT_NAME)?sid=\" + SessionId;"
     puts {
@@ -377,7 +377,7 @@
                                         table_row {
                                             table_data {
                                                 division {class="CLASS20908" style="display: none"} {id="btnFwDownload"} {} "onClick=\"window.location.href='$REMOTE_FIRMWARE_SCRIPT?cmd=download&version=$cur_version&serial=$serial&lang=de&product=HM-CCU2';\"" {}
-                                                division {class="CLASS20908"}  "onClick=\"showCCULicense();\"" {puts "\${dialogSettingsCMBtnPerformSoftwareUpdateDownload}"}
+                                                division {class="CLASS20908"}  "onClick=\"window.open('https://github.com/jens-maus/RaspberryMatic/releases','_blank');\"" {puts "\${dialogSettingsCMBtnPerformSoftwareUpdateDownload}"}
                                             }
                                         }
                                     }
@@ -429,6 +429,7 @@
                     }
                 }
                 table_data {align="left"} {class="CLASS20921"} {
+                    puts "\${dialogSettingsCMHintSoftwareUpdateRaspMatic}<br/>"
                     puts "\${dialogSettingsCMHintSoftwareUpdate1}"
                     number_list {class="j_noForcedUpdate"} {
                         li {
@@ -467,6 +468,21 @@
                     puts "\${dialogSettingsCMHintRestart}"
                 }
             }
+            table_row {class="CLASS20902 j_noForcedUpdate j_fwUpdateOnly"} {
+                table_data {class="CLASS20903"} $styleMaxWidth {
+		                puts "\${dialogSettingsCMTDCCUShutdown}"
+                }
+                table_data {class="CLASS20904"} {
+                    division {class="popupControls CLASS20905"} {
+                        division {class="CLASS20910"} {onClick="OnShutdown();"} {
+                            puts "\${dialogSettingsCMBtnCCUShutdown}"
+                        }
+                    }
+                }
+                table_data {align="left"} {class="CLASS20904"} {
+                    puts "\${dialogSettingsCMHintShutdown}"
+                }
+            }
             
             # Abgesicherter Modus
             table_row {class="CLASS20902 j_noForcedUpdate j_fwUpdateOnly"} {
@@ -488,78 +504,78 @@
             }
 
             # Version Logikschicht
-            table_row {class="CLASS20902 j_noForcedUpdate j_fwUpdateOnly"} {
-
-              table_data {class="CLASS20903"} $styleMaxWidth {
-                puts "\${lblTDRegaVersion}"
-              }
-
-              table_data {class="CLASS20904"} {
-
-                table {class="CLASS20909"} {
-                  table_row {
-                    table_data {
-                      puts "\${dialogHelpInfoLblVersion}"
-                    }
-                    table_data {align="left"} {
-                      puts "<select id='selectedReGaVersion'>"
-                        puts "<option value='NORMAL'>\${optionReGaNORMAL}</option>"
-                        puts "<option value='LEGACY'>\${optionReGaLEGACY}</option>"
-                        puts "<option value='COMMUNITY'>\${optionReGaCOMMUNITY}</option>"
-                      puts "</select>"
-                    }
-                  }
-
-                  table_row {
-                    table_data {}
-                    table_data {align="left"} {
-                      division {class="popupControls CLASS20905"} {
-                        division {class="CLASS20919"} {onClick="saveRegaVersion(this);"} {
-                            puts "\${btnSave}"
-                        }
-                      }
-                    }
-                  }
-                }
-              }
+            #table_row {class="CLASS20902 j_noForcedUpdate j_fwUpdateOnly"} {
 
-              table_data {align="left"} {class="CLASS20904"} {
-                puts "\${lblTDReGaVersionHelp}"
-              }
-            }
-
-            cgi_javascript {
-              puts "var url = \"$env(SCRIPT_NAME)?sid=\" + SessionId;"
-              puts {
-
-                homematic("User.getReGaVersion",{}, function(result) {
-                  if (result) {
-                    jQuery("#selectedReGaVersion").val(result);
-                  } else {
-                    jQuery("#selectedReGaVersion").val("NORMAL");
-                  }
-                });
-
-                saveRegaVersion = function(elm) {
-                  jQuery(elm).css({"border-width" : "2px"});
-                  var selectedReGa = jQuery("#selectedReGaVersion").val();
-                  homematic("User.setReGaVersion", {"ReGaVersion": selectedReGa}, function() {
-                    jQuery(elm).css({"border-width" : "1px"});
-
-                    var dlgYesNo = new YesNoDialog(translateKey("dialogPerformRebootTitle"), translateKey("dialogRestart2ChanceReGaVersion"), function(result) {
-                      if (result == YesNoDialog.RESULT_YES)
-                      {
-                        dlgPopup.hide();
-                        dlgPopup.setWidth(400);
-                        dlgPopup.LoadFromFile(url, "action=reboot_confirm");
-                      }
-                    });
-                    dlgYesNo.btnTextYes(translateKey("dialogBtnPerformRestart"));
-                    dlgYesNo.btnTextNo(translateKey("dialogBtnPerformLaterRestart"));
-                  });
-                }
-              }
-            }
+            #  table_data {class="CLASS20903"} $styleMaxWidth {
+            #    puts "\${lblTDRegaVersion}"
+            #  }
+
+            #  table_data {class="CLASS20904"} {
+
+            #    table {class="CLASS20909"} {
+            #      table_row {
+            #        table_data {
+            #          puts "\${dialogHelpInfoLblVersion}"
+            #        }
+            #        table_data {align="left"} {
+            #          puts "<select id='selectedReGaVersion'>"
+            #            puts "<option value='NORMAL'>\${optionReGaNORMAL}</option>"
+            #            puts "<option value='LEGACY'>\${optionReGaLEGACY}</option>"
+            #            puts "<option value='COMMUNITY'>\${optionReGaCOMMUNITY}</option>"
+            #          puts "</select>"
+            #        }
+            #      }
+
+            #      table_row {
+            #        table_data {}
+            #        table_data {align="left"} {
+            #          division {class="popupControls CLASS20905"} {
+            #            division {class="CLASS20919"} {onClick="saveRegaVersion(this);"} {
+            #                puts "\${btnSave}"
+            #            }
+            #          }
+            #        }
+            #      }
+            #    }
+            #  }
+
+            #  table_data {align="left"} {class="CLASS20904"} {
+            #    puts "\${lblTDReGaVersionHelp}"
+            #  }
+            #}
+
+            #cgi_javascript {
+            #  puts "var url = \"$env(SCRIPT_NAME)?sid=\" + SessionId;"
+            #  puts {
+
+            #    homematic("User.getReGaVersion",{}, function(result) {
+            #      if (result) {
+            #        jQuery("#selectedReGaVersion").val(result);
+            #      } else {
+            #        jQuery("#selectedReGaVersion").val("NORMAL");
+            #      }
+            #    });
+
+            #    saveRegaVersion = function(elm) {
+            #      jQuery(elm).css({"border-width" : "2px"});
+            #      var selectedReGa = jQuery("#selectedReGaVersion").val();
+            #      homematic("User.setReGaVersion", {"ReGaVersion": selectedReGa}, function() {
+            #        jQuery(elm).css({"border-width" : "1px"});
+
+            #        var dlgYesNo = new YesNoDialog(translateKey("dialogPerformRebootTitle"), translateKey("dialogRestart2ChanceReGaVersion"), function(result) {
+            #          if (result == YesNoDialog.RESULT_YES)
+            #          {
+            #            dlgPopup.hide();
+            #            dlgPopup.setWidth(400);
+            #            dlgPopup.LoadFromFile(url, "action=reboot_confirm");
+            #          }
+            #        });
+            #        dlgYesNo.btnTextYes(translateKey("dialogBtnPerformRestart"));
+            #        dlgYesNo.btnTextNo(translateKey("dialogBtnPerformLaterRestart"));
+            #      });
+            #    }
+            #  }
+            #}
 
             table_row {class="CLASS20902 j_noForcedUpdate j_fwUpdateOnly"} {
                 table_data {class="CLASS20903"} $styleMaxWidth  {
@@ -721,6 +737,12 @@
                 dlgPopup.LoadFromFile(url, "action=reboot_confirm");
             }
             
+            OnShutdown = function() {
+                dlgPopup.hide();
+                dlgPopup.setWidth(400);
+                dlgPopup.LoadFromFile(url, "action=shutdown_confirm");
+            }
+            
             OnEnterSafeMode = function() {
               new YesNoDialog(translateKey("dialogSafetyCheck"), translateKey("dialogQuestionRestartSafeMode"), function(result) {
                 if (result == YesNoDialog.RESULT_YES)
@@ -818,25 +840,25 @@
 
 proc action_firmware_upload {} {
     global env sid downloadOnly
-    cd /tmp/
+    cd /usr/local/tmp/
     
     http_head
     import_file -client firmware_file
 
     # check if the uploaded file looks like a firmware file
-    set file_valid 0
-    catch {
-        #set file_valid [expr [string first "update_script" [exec tar tzf [lindex $firmware_file 0]]] >= 0 ]
-        exec tar zxvf [lindex $firmware_file 0] update_script EULA.en EULA.de EULA.tr -C /var/
-    }
-    set file_valid [file exists "/var/update_script"]
-
-    if {$file_valid} {
-      file rename -force -- [lindex $firmware_file 0] "/var/new_firmware.tar.gz"
-      #set action "firmware_update_confirm"
-      set action "acceptEula"
+    set invalid_file [catch {exec unzip -q -o -d /usr/local/tmp [lindex $firmware_file 0]} result]
+    if {$invalid_file == 0} {
+      set invalid_file [catch {file exists [glob /usr/local/tmp/*-*\.img]} result]
+      if {$invalid_file == 0} {
+        set invalid_file [catch {exec sha256sum -c [glob /usr/local/tmp/*-*\.img\.sha256]} result]
+      }
+    }
+    file delete -force -- [lindex $firmware_file 0]
+
+    if {$invalid_file == 0} {
+        set action "firmware_update_confirm"
+        #set action "acceptEula"
     } else {
-        file delete -force -- [lindex $firmware_file 0]
         set action "firmware_update_invalid"
     }
     cgi_javascript {
@@ -934,6 +956,89 @@
     }
 }
 
+proc action_shutdown_confirm {} {
+   global env
+   
+    http_head
+    division {class="popupTitle"} {
+        puts "\${dialogSafetyCheck}"
+    }
+    division {class="CLASS20900"} {
+        table {class="popupTable CLASS20901"} {border="1"} {
+            table_row {
+                table_data {
+                    table {class="CLASS20909"} {width="100%"} {
+                        table_row {
+                            table_data {colspan="3"} {
+			        puts "\${dialogQuestionShutdown}"
+                            }
+                        }                        
+                        table_row {
+                            table_data {align="right"} {class="CLASS20911"} {colspan="3"} {
+                                division {class="popupControls CLASS20905"} {
+                                    division {class="CLASS20910"} {onClick="OnNextStep()"} {
+                                        puts "\${dialogBtnPerformShutdown}"
+                                    }
+                                }
+                            }
+                        }
+                    }
+                }
+            }
+        }
+    }
+    division {class="popupControls"} {
+        table {
+            table_row {
+                table_data {class="CLASS20907"} {
+                    division {class="CLASS20908"} {onClick="dlgPopup.hide();showMaintenanceCP();"} {
+                        puts "\${btnCancel}"
+                    }
+                }
+            }
+        }
+    }
+    puts ""
+    cgi_javascript {
+        puts "var url = \"$env(SCRIPT_NAME)?sid=\" + SessionId;"
+        puts {
+            OnNextStep = function() {
+                regaMonitor.stop();
+                InterfaceMonitor.stop();
+                dlgPopup.hide();
+                dlgPopup.setWidth(400);
+                dlgPopup.LoadFromFile(url, "action=shutdown_go");
+            }
+        }
+        puts "dlgPopup.readaptSize();"
+        puts "translatePage('#messagebox')"
+    }
+}
+
+proc action_shutdown_go {} {
+    global env
+    cd /tmp/
+    
+    http_head
+
+    put_message "\${dialogPerformShutdownTitle}" {
+        ${dialogPerformShutdownContent}
+    } "_empty_"
+
+    puts ""
+    cgi_javascript {
+        puts "var url = \"$env(SCRIPT_NAME)?sid=\" + SessionId;"
+        puts {
+            var pb = "action=shutdown";
+            var opts = {
+                postBody: pb,
+                sendXML: false
+            };
+            new Ajax.Request(url, opts);
+        }
+    }
+}
+
 proc action_update_start {} {
     catch { exec killall hss_lcd }
     catch { exec lcdtool {Saving     Data...    } }
@@ -952,8 +1057,17 @@
     catch { exec lcdtool {Saving     Data...    } }
     rega system.Save()
     catch { exec lcdtool {Reboot...             } }
+    exec sleep 5
     exec /sbin/reboot
 }
+proc action_shutdown {} {
+    catch { exec killall hss_lcd }
+    catch { exec lcdtool {Saving     Data...    } }
+    rega system.Save()
+    catch { exec lcdtool {Shutdown...           } }
+    exec sleep 5
+    exec /sbin/poweroff
+}
 
 proc get_logserver {} {
     return [read_var //etc/config/syslog LOGHOST]
--- homematic/WebUI/www/config/cp_network.cgi.orig
+++ homematic/WebUI/www/config/cp_network.cgi
@@ -610,13 +610,18 @@
   }
   set serial [get_serial]
   cgi_javascript {
-    puts "var cert_url = \"$REMOTE_CERT_SCRIPT?serial=$serial\";"
+    puts "var serial = \"$serial\";"
     puts {
       OnGetCert = function() {
-      cert_url += "&country="+document.getElementById("text_country").value;
-      cert_url += "&url="+document.getElementById("text_url").value;
-      cert_url += "&mail="+document.getElementById("text_mail").value;
-      window.location.href=cert_url;
+        var country = document.getElementById("text_country").value;
+        var hostname = document.getElementById("text_url").value;
+        var email = document.getElementById("text_mail").value;
+        homematic("User.createCertificate", {"country": country, "hostname": hostname, "email": email, "serial": serial}, function() {
+          homematic("User.restartLighttpd", {}, function(){
+            MessageBox.show(translateKey("dialogRestartWebserverTitle"),translateKey("dialogRestartWebserverContent"));
+            window.setTimeout(function() {window.location.protocol = "http"},2000);
+          });
+        });
       };
 
       deleteCert = function() {
--- homematic/WebUI/www/config/cp_security.cgi.orig
+++ homematic/WebUI/www/config/cp_security.cgi
@@ -192,7 +192,7 @@
         }
     }
     catch {
-        exec run-parts /etc/config/rc.d stop
+        exec run-parts -a stop /etc/config/rc.d
     }
     if { [catch {
         exec crypttool -r
@@ -202,8 +202,8 @@
         # exec /usr/sbin/ubiattach -p /dev/mtd6
         # exec /usr/sbin/ubimkvol /dev/ubi1 -N user -m
         # exec mount /usr/local
-        exec touch /var/doFactoryReset
-        exec kill -SIGQUIT 1
+        exec touch /usr/local/.doFactoryReset
+        exec /sbin/reboot
     }]} {
 
       # TWIST-22
@@ -278,13 +278,13 @@
 
 proc action_backup_restore_check {} {
     global env
-    cd /tmp/
+    cd /usr/local/tmp/
     
     http_head
     set i 0
     if { [catch {
-        exec tar xf new_config.tar
-        file delete -force /tmp/new_config.tar
+        exec tar xf /usr/local/tmp/new_config.tar 2>/dev/null
+        file delete -force /usr/local/tmp/new_config.tar
     
     set config_version [read_version "firmware_version"]
     set ccu1_backup false
@@ -414,7 +414,7 @@
 
 proc action_backup_restore_go {} {
     global env
-    cd /tmp/
+    cd /usr/local/tmp/
     http_head
     
     set system_version [read_version "/boot/VERSION"]
@@ -476,14 +476,14 @@
     }
     
   if { "false" == $ccu1_backup } {  # backup for version >= 2
-    exec umount /usr/local
-          exec /usr/sbin/ubidetach -p /dev/mtd6
-          exec /usr/sbin/ubiformat /dev/mtd6 -y
-          exec /usr/sbin/ubiattach -p /dev/mtd6
-          exec /usr/sbin/ubimkvol /dev/ubi1 -N user -m
-          exec mount /usr/local
+    #exec umount /usr/local
+          #exec /usr/sbin/ubidetach -p /dev/mtd6
+          #exec /usr/sbin/ubiformat /dev/mtd6 -y
+          #exec /usr/sbin/ubiattach -p /dev/mtd6
+          #exec /usr/sbin/ubimkvol /dev/ubi1 -N user -m
+          #exec mount /usr/local
 
-    if { [catch {exec tar xzf /tmp/usr_local.tar.gz} errorMessage] } {
+    if { [catch {exec touch /usr/local/.doBackupRestore} errorMessage] } {
       # set msg "Beim Einspielen des Systembackups ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut. "
       # append msg "Falls dieser Fehler wiederholt Auftritt, wenden Sie sich bitte mit der folgenden Fehlermeldung an den Kundenservice:\n<br>"
       # append msg $errorMessage
@@ -493,23 +493,27 @@
       set backuperror false
     }    
   } else {  # backup for version < 2      
+    catch {
+        exec killall ReGaHss
+        exec sleep 5
+    }
     #delete existing files
-    file delete -force /tmp/backup
+    file delete -force /usr/local/tmp/backup
     file delete -force /etc/config/hs485d /etc/config/hs485types /etc/config/rfd /etc/config/userprofiles 
     file delete -force /etc/config/homematic.regadom /etc/config/homematic.regadom.bak
     file delete -force /etc/config/ids /etc/config/ntpclient /etc/config/rega.conf /etc/config/syslog 
     file delete -force /etc/config/tweaks /etc/config/TZ /etc/config/server.pem /etc/config/keys
     file delete -force /etc/config/time.conf
     
-    file mkdir /tmp/backup
-    cd /tmp/backup
-    if { [catch {exec tar xzf /tmp/usr_local.tar.gz} errorMessage] } {
+    file mkdir /usr/local/tmp/backup
+    cd /usr/local/tmp/backup
+    if { [catch {exec tar xzf /usr/local/tmp/usr_local.tar.gz} errorMessage] } {
       put_message "\${dialogSettingsSecurityMessageSysBackupErrorTitle}" "\${dialogSettingsSecurityMessageSysBackupErrorContent} $errorMessage"
       set backuperror true
     } else {
       #copy old files
-      if { [file exists /tmp/backup/usr/local/etc/config] } {
-        cd /tmp/backup/usr/local/etc/config
+      if { [file exists /usr/local/tmp/backup/usr/local/etc/config] } {
+        cd /usr/local/tmp/backup/usr/local/etc/config
       }
       
       if { [file exists hs485d] } { file copy hs485d /etc/config/hs485d }        
@@ -563,6 +567,8 @@
       catch {exec eq3configcmd rfd-interface-copy rfd.conf /etc/config/rfd.conf}
 
       set backuperror false
+      exec /sbin/reboot
+      return
     }          
     cd /
   }
@@ -609,7 +615,6 @@
       puts "translatePage('#messagebox');"
     }
 
-    file delete -force /tmp/new_config.tar /tmp/firmware_version /tmp/signature /tmp/usr_local.tar.gz /tmp/backup
 }
 
 proc put_message {title msg args} {
@@ -1051,39 +1056,36 @@
 
 proc action_create_backup {} {
     set HOSTNAME [exec hostname]
+    set system_version [read_version "/boot/VERSION"]
     set iso8601_date [exec date -Iseconds]
+    set tmpdir [exec mktemp -d -p /usr/local/tmp]
     regexp {^(\d+)-(\d+)-(\d+)T(\d+):(\d+):(\d+)([+-]\d+)$} $iso8601_date dummy year month day hour minute second zone
+    set backupfile [set HOSTNAME]-$system_version-$year-$month-$day-$hour$minute.sbk
     #save DOM
     rega system.Save()
     cd /
-    exec tar czf /tmp/usr_local.tar.gz usr/local
-    cd /tmp/
+    exec tar --exclude=usr/local/tmp --exclude=usr/local/lost+found -czf $tmpdir/usr_local.tar.gz usr/local
+    cd $tmpdir/
     #sign the configuration with the current key
     exec crypttool -s -t 1 <usr_local.tar.gz >signature
     #store the current key index
     exec crypttool -g -t 1 >key_index
     file copy -force /boot/VERSION firmware_version
-    set fd [open "|tar c usr_local.tar.gz signature firmware_version key_index"]
-    catch {fconfigure $fd -translation binary}
-    catch {fconfigure $fd -encoding binary}
-    puts "Content-Type:application/x-download"
-    puts "Content-Disposition:attachment;filename=[set HOSTNAME]-$year-$month-$day.sbk\n"
-    catch {fconfigure stdout -translation binary}
-    catch {fconfigure stdout -encoding binary}
-    while { ! [eof $fd]} {
-        puts -nonewline [read $fd 65536]
-    }
-    close $fd
-    file delete -force /tmp/usr_local.tar.gz /tmp/firmware_version /tmp/signature
+    exec tar -cf /usr/local/tmp/last_backup.sbk usr_local.tar.gz signature firmware_version key_index
+    cd /
+    exec rm -rf $tmpdir
+    puts "X-Sendfile: /usr/local/tmp/last_backup.sbk"
+    puts "Content-Type: application/octet-stream"
+    puts "Content-Disposition: attachment; filename=\"$backupfile\"\n"
 }
 
 proc action_backup_upload {} {
     global env sid
-    cd /tmp/
+    cd /usr/local/tmp/
     
     http_head
     import_file -client backup_file
-    file rename -force -- [lindex $backup_file 0] "/tmp/new_config.tar"
+    file rename -force -- [lindex $backup_file 0] "/usr/local/tmp/new_config.tar"
     cgi_javascript {
         puts "var url = \"$env(SCRIPT_NAME)?sid=$sid\";"
         puts {
--- homematic/WebUI/www/config/cp_software.cgi.orig
+++ homematic/WebUI/www/config/cp_software.cgi
@@ -488,11 +488,11 @@
 
 proc action_image_upload {} {
     global env sid
-    cd /tmp/
+    cd /usr/local/tmp/
     
     http_head
     import_file -client firmware_file
-    file rename -force -- [lindex $firmware_file 0] "/var/new_firmware.tar.gz"
+    file rename -force -- [lindex $firmware_file 0] "/usr/local/tmp/new_addon.tar.gz"
     cgi_javascript {
         puts "var url = \"$env(SCRIPT_NAME)?sid=$sid\";"
         puts {
@@ -507,7 +507,8 @@
     if {[isOldCCU]} {
         exec /sbin/init -q
     } else {
-        exec /bin/kill -SIGQUIT 1
+        exec touch /usr/local/.doAddonInstall
+        exec /sbin/reboot
     }
 }
 
--- homematic/WebUI/www/config/cp_time.cgi.orig
+++ homematic/WebUI/www/config/cp_time.cgi
@@ -645,7 +645,9 @@
     if { $fd <0 } { return 0 }
     puts $fd "$TIMEZONES($timezone)"
     close $fd
-    
+ 
+    catch {exec /bin/updateTZ.sh}
+   
     rega_script "var x=system.Longitude($lon);var y=system.Latitude($lat);var a=dom.ChangedTimeManually();"
     
     catch {exec /sbin/hwclock -wu}
--- homematic/WebUI/www/config/ic_common.tcl.orig
+++ homematic/WebUI/www/config/ic_common.tcl
@@ -23,10 +23,10 @@
 set GL_FLAG_RECEIVER_UNKNOWN     0x8
 
 set HTMLTITLE "HomeMatic Interne Konfiguration"
-set INTERFACES_FILE "/opt/hm/etc/config/InterfacesList.xml"
+set INTERFACES_FILE "/etc/config/InterfacesList.xml"
 
 if { ![info exists env(CONFIG_ROOT)] } {
-    set env(CONFIG_ROOT) "/opt/hm/etc/config"
+    set env(CONFIG_ROOT) "/etc/config"
 }
 
 set USERPROFILESPATH "$env(CONFIG_ROOT)/userprofiles"
@@ -850,28 +850,31 @@
   if { (![info exist env(IC_OPTIONS)]) || ([string first NO_PROFILE_MAPPING $env(IC_OPTIONS)] < 0) } {
       # Verknuepfungen dem array map_link zuweisen
       read_links
-  
-      # Handelt es sich um ein Profil der Firmwareversion 1.4?
-      if {[info exists map_link($sender_address-$receiver_address)]} {
-        set new_profile_is_set "true"
-      }
-  
-      #1
 
-      # Wenn noch nicht geschehen, dann die Profile beim Wechsel von 
-      # Firmwareversionen < 1.4 auf die neue Profilstruktur in >= 1.4 mappen 
-      if {$cur_profile != "" && $new_profile_is_set == ""} then {
-      upvar PROFILE_$cur_profile PROFILE
-  
-        if {! [catch {set map_prn $PROFILE(UI_MAP)}]}  {
-          set cur_profile $map_prn
-          set mapped_profile $map_prn
-        #  puts "<p style=\"color:red; text-decoration:blink\">Mapped profile!<p>"
-        }  
+      catch {
+          # Handelt es sich um ein Profil der Firmwareversion 1.4?
+          if {[info exists map_link($sender_address-$receiver_address)]} {
+            set new_profile_is_set "true"
+          }
+
+
+        #1
+
+        # Wenn noch nicht geschehen, dann die Profile beim Wechsel von
+        # Firmwareversionen < 1.4 auf die neue Profilstruktur in >= 1.4 mappen
+        if {$cur_profile != "" && $new_profile_is_set == ""} then {
+        upvar PROFILE_$cur_profile PROFILE
+
+          if {! [catch {set map_prn $PROFILE(UI_MAP)}]}  {
+            set cur_profile $map_prn
+            set mapped_profile $map_prn
+          #  puts "<p style=\"color:red; text-decoration:blink\">Mapped profile!<p>"
+          }
+        }
+
+        if {$mapped_profile != "unset"} {set cur_profile $mapped_profile}
+        # end mapping....
       }
-  
-      if {$mapped_profile != "unset"} {set cur_profile $mapped_profile}
-      # end mapping.... 
   }
 
   if {$cur_profile != ""} then {
@@ -1067,9 +1070,14 @@
   #Evtl. irgendwann umbauen.
   global iface_url
   set channel_type ""
+  set chn ""
+
+  set hmDisEPIdentifier "HM-Dis-EP-WM55"
+  set hmDisWM55Identifier "HM-Dis-WM55"
 
   if { ! [catch { array set ch_descr [xmlrpc $iface_url($iface) getDeviceDescription [list string $address]] } ] } then {
     set channel_type $ch_descr(TYPE)
+    catch {set chn $ch_descr(INDEX)}
     set parent_type ""
     catch {set parent_type $ch_descr(PARENT_TYPE)}
   }
@@ -1106,6 +1114,10 @@
 
     if {[info exists unit] == 0} {
      set unit ""
+    } else {
+      if {($unit == "??C") || ($unit == "Â°C")} {
+        set unit "&#176;C"
+      }
     }
 
     # omit internal and invisible parameters
@@ -1123,7 +1135,14 @@
     if {$ps_type == "MASTER" && $parent_type == "" } then {
       append s "<td><span class=\"stringtable_value\">${param_id}</span></td>"
     } elseif {$ps_type == "MASTER" || $ps_type == "VALUES"} then {
-      append s "<td><span class=\"stringtable_value\">$channel_type|${param_id}</span></td>"
+      # We have to rename the translation of the parameters for the channels >=4 of the HM-Dis-EP-WM55 (Text Zeile x > Text Block x)
+      if {($parent_type != $hmDisEPIdentifier) || ($chn < 4)} {
+        # original translation
+        append s "<td><span class=\"stringtable_value\">$channel_type|${param_id}</span></td>"
+      } else {
+        # new translation
+        append s "<td><span>\${lblTextBlock}</span></td>"
+      }
     } else {
 
       # Nötig, zum übersetzen der Parameter auf der Senderseite (wie PEER_NEEDS_BURST, oder EXPECT_AES)
@@ -1149,17 +1168,40 @@
         } else {
           puts "<script type=\"text/javascript\">load_JSFunc('/config/easymodes/MASTER_LANG/KEY_4Dis.js');</script>"
           set helpText [getStatusDisplayHelp]
-          array set dev_descr [xmlrpc $url getDeviceDescription [list string $address]]
-          set chn $dev_descr(INDEX)
-          if {$param_id == "TEXTLINE_1"} {
-            # Fortlaufende Nummerierung der Textblöcke hinzufügen.
-            # Berechnung:
-            # 1. Parameter = Kanalnummer * 2 - 1
-            append s "<td>[expr $chn * 2 - 1]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" onblur=\"encodeStringStatusDisplay('$idval', true);\" value=\"$value\" $id $access /></td>"
+
+          # The parameter numbering of the channels 1 and 2 are the same as from the HM-Dis-WM55
+          if {($parent_type != $hmDisEPIdentifier) || ($chn < 4)} {
+            if {$param_id == "TEXTLINE_1"} {
+              # Fortlaufende Nummerierung der Textblöcke hinzufügen.
+              # Berechnung:
+              # 1. Parameter = Kanalnummer * 2 - 1
+              if {($parent_type != $hmDisEPIdentifier) && ($parent_type != $hmDisWM55Identifier)} {
+                append s "<td>[expr $chn * 2 - 1]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" maxlength=\"12\" onblur=\"encodeStringStatusDisplay('$idval', true);\" value=\"$value\" $id $access /></td>"
+              } else {
+                append s "<td>[expr $chn * 2 - 1]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" maxlength=\"12\" onblur=\"encodeStringStatusDisplay('$idval', true, '_');\" value=\"$value\" $id $access /></td>"
+              }
+            } else {
+              # 2. Parameter = Kanalnummer * 2
+              if {($parent_type != $hmDisEPIdentifier) && ($parent_type != $hmDisWM55Identifier)} {
+                append s "<td>[expr $chn * 2]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" maxlength=\"12\" onblur=\"encodeStringStatusDisplay('$idval', true);\" value=\"$value\" $id $access /></td>"
+              } else {
+                append s "<td>[expr $chn * 2]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" maxlength=\"12\" onblur=\"encodeStringStatusDisplay('$idval', true, '_');\" value=\"$value\" $id $access /></td>"
+              }
+
+              append s "<td><img src=\"/ise/img/help.png\"/ size=\"24\" width=\"24\" onclick=\"MessageBox.show(translateKey('dialogHelpTitle'), '$helpText', '', 450, 375) ;\"></td>"
+            }
           } else {
-            # 2. Parameter = Kanalnummer * 2
-            append s "<td>[expr $chn * 2]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" value=\"$value\" $id $access /></td>"
-            append s "<td><img src=\"/ise/img/help.png\"/ size=\"24\" width=\"24\" onclick=\"MessageBox.show(translateKey('dialogHelpTitle'), '$helpText', '', 450, 320) ;\"></td>"
+            # Here we set the parameter numbering for the channels 4 - 8 of the HM-Dis-EP-WM55
+            if {$param_id == "TEXTLINE_1"} {
+              # Fortlaufende Nummerierung der Textblöcke hinzufügen.
+              # Berechnung:
+              # 1. Parameter = Kanalnummer * 2 - 7
+              append s "<td>[expr $chn * 2 - 7]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" maxlength=\"12\" onblur=\"encodeStringStatusDisplay('$idval', true, '_');\" value=\"$value\" $id $access /></td>"
+            } else {
+              # 2. Parameter = Kanalnummer * 2 -6
+              append s "<td>[expr $chn * 2 - 6]&nbsp;&nbsp;<input type=\"text\" name=\"$param_id\" maxlength=\"12\" onblur=\"encodeStringStatusDisplay('$idval', true, '_');\" value=\"$value\" $id $access /></td>"
+              append s "<td><img src=\"/ise/img/help.png\"/ size=\"24\" width=\"24\" onclick=\"MessageBox.show(translateKey('dialogHelpTitle'), '$helpText', '', 450, 375) ;\"></td>"
+            }
           }
         }
         append s "<td>$unit</td>"
@@ -1249,7 +1291,7 @@
           append s "<input type=\"hidden\" name=\"$param_id\"   value=\"$value_orig\" $id                 $access style=\"visibility:hidden;display:none;\" />"
           append s "<input type=\"text\"   name=\"__$param_id\" value=\"$value\"       id=\"$input_idval\" $access $hidden"
           append s "  onkeyup=\"ProofAndSetValue('$input_idval', '${idval}', parseInt($min), parseInt($max), parseFloat([expr 1 / $factor]));\" /></td>"
-          append s "<td><div id=\"${input_idval}_unit\" $hidden class=\"stringtable_value\">$unit ($min-$max)</div></td>"
+          append s "<td><div id=\"${input_idval}_unit\" $hidden class=\"_stringtable_value\">$unit ($min-$max)</div></td>"
       }
       "FLOAT" {
         set input_idval   ${idval}_temp
@@ -1691,7 +1733,9 @@
   upvar $ps_arr ps
   set pname $name 
   set s ""
-  set value $ps($pname)
+  # change because of HmIP
+  # set value $ps($pname)
+  set value [lindex $ps($pname) 0]
 
   if {[string first "." $value] >= 0} then {
     set value [format "%.1f" $value]
@@ -1866,7 +1910,7 @@
   if {$paramids != ""} then {
     foreach filename $paramids {
 
-      if { [file exists easymodes/$filename.tcl] } then {
+      if { [file exists easymodes/$filename.tcl] || [file exists easymodes/hmip/$filename.tcl] } then {
         set paramid $filename
         break
       }
--- homematic/WebUI/www/config/st_values.cgi.orig
+++ homematic/WebUI/www/config/st_values.cgi
@@ -0,0 +1,75 @@
+#!/bin/tclsh
+source ../cgi.tcl
+
+set ST_FILENAME "$env(DOCUMENT_ROOT)/config/stringtable_de.txt"
+set JS_FILENAME "$env(DOCUMENT_ROOT)/config/st_values.js"
+	
+proc put_js_functions {} {
+
+	global JS_FILENAME
+	
+	if { ! [catch {open $JS_FILENAME "r"} jsfile] } then {
+
+		while {! [eof $jsfile] } {
+			gets $jsfile zeile
+
+			#Weiche EOF-Marke:
+			if {$zeile == "//<."} then { break }
+			
+			puts $zeile
+		}
+
+		catch {close $jsfile}
+	}
+}
+
+proc parse_line {zeile p_context p_value} {
+
+	upvar $p_context context
+	upvar $p_value   value
+	
+	set tokenizer [split $zeile "\t"]
+	
+	set context [lindex $tokenizer 0]
+	set value   [lindex $tokenizer 1]
+}
+
+proc parse_file {} {
+
+	global ST_FILENAME
+	
+	if { ! [catch {open $ST_FILENAME "r"} stFile] } then {
+
+		puts "elvST = new Array();"
+		
+		while {! [eof $stFile] } {
+			gets $stFile zeile
+
+			if {$zeile == ""} then {
+				continue
+			}
+
+      		if { [regexp {^([^\t]*)\t+(.*)$} $zeile dummy key value] } then {
+	      		if { [regexp {^<.*>$} $value] } then {
+					#Dieser Parameter wurde noch nicht übersetzt. Nicht ins JavaScript-Array einfü!
+					continue
+				}
+			}
+
+			set context ""
+			set value ""
+			
+			parse_line $zeile context value
+			
+			puts "elvST\['$context'\] = '$value';"
+		}
+		
+    	catch {close $stfile}
+	}
+}
+
+cgi_http_head {
+  cgi_content_type "text/javascript; charset=iso-8859-1"
+}
+parse_file
+put_js_functions
--- homematic/WebUI/www/config/st_values.js.orig
+++ homematic/WebUI/www/config/st_values.js
@@ -0,0 +1,138 @@
+/*
+Ãbersetzt den Inhalt der HTML-Elemente <span class="stringtable_value">...</span>
+und <select class="stringtable_select">...</select>
+*/
+st_setStringTableValues = function()
+{
+	var translation;
+	
+	//In <span class="stringtable_value">...</span> eingeschlossene WÃ¶rter Ã¼bersetzen
+	var temp = document.getElementsByClassName('stringtable_value');
+  
+    var wrappers = new Array();
+	for (var i=0; i<temp.length; i++)
+	{	
+		wrappers[i]=temp[i];
+	}
+    
+	for (var i=0; i<wrappers.length; i++)
+	{	
+		wrappers[i].innerHTML = st_getValue( wrappers[i].innerHTML ).escapeHTML();
+		wrappers[i].className += "_translated";
+	}
+	//-------------------------------------------------------------------------
+
+	//Comboboxen Ã¼bersetzen <select class="stringtable_select" ... >...</select>
+	var temp = document.getElementsByClassName('stringtable_select');
+
+	var selboxes = new Array();
+	for (var i = 0, len = temp.length; i < len; i++)
+	{
+		selboxes[i] = temp[i];
+	}
+	
+	for (var i=0; i<selboxes.length; i++)
+	{
+		var selectelem = selboxes[i];
+
+		if (selectelem.type != "select-one") continue;
+		
+		for (var k=0; k<selectelem.options.length; k++)
+		{
+			selectelem.options[k].text = st_getValue(selectelem.options[k].text).escapeHTML();
+		}
+
+		selectelem.className += "_translated";
+	}
+	//-------------------------------------------------------------------------
+	
+	//Input-Felder Ã¼bersetzen <input class="stringtable_input" ...> 
+	var temp = document.getElementsByClassName('stringtable_input');
+
+	var input = new Array();
+	for (var i = 0, len = temp.length; i < len; i++)
+	{
+		input[i] = temp[i];
+	}
+
+	for (var i = 0; i < input.length; i ++)
+	{
+		input[i].value = st_getValue(input[i].value).escapeHTML();
+		input[i].className += "_translated";
+	}
+
+};
+
+//Eingabeparameter
+//context: <channeltype>|<value_id>(=<value>)?
+//context: <channeltype>|<value_id>
+//context: <value_id>
+//RÃ¼ckgabeparameter:
+//return: Ã¼bersetzung, wenn context gefunden in den Spezialisierungsgraden:
+//	1. <channeltype>|<value_id>(=<value>)?
+//	2. <channeltype>|<value_id>
+//	3. <value_id>
+//	sonst: value, wenn value aus dem context extrahiert werden kann
+//	sonst: context wird wieder zurÃ¼ckgegeben.
+st_getValue = function(context)
+{
+	var translation;
+	var tokens;
+	var channel_type;
+	var value_id_assign; //Inhalt: <value_id>=<value>
+	var value_id;
+	var value;
+		
+	//Voller context vorhanden?=========================================
+	translation = elvST[context];
+
+	if (translation && translation != "") return translation;
+	//==================================================================
+	
+	//Gibt es einen Eintrag nur mit value_id_assign?====================
+	tokens = context.split('|');
+	value_id_assign = "";
+	
+	if (tokens.length > 1)
+	{
+		//channel_type = tokens[0];
+		value_id_assign = tokens[1];
+		translation = elvST[ value_id_assign ];
+		if (translation && translation != "") return translation;
+	}
+	//==================================================================
+
+	//Gibt es einen Eintrag nur mit dem Variablennamen?=================
+	tokens = context.split('=');
+	value = "";
+	
+	if (tokens.length > 1)
+	{
+		//value_id = tokens[0];
+		value = tokens[1];
+		translation = elvST[ value ];
+		if      (translation && translation != "") return translation;
+		else if (value       && value       != "") return value;
+	}
+	//==================================================================
+	
+	//Gibt es einen Eintrag im INPUT-Feld?==============================
+
+	tokens = context.split(" ");
+	translation = "";
+
+	for (var i = 0; i < tokens.length; i++)
+	{
+		if (typeof elvST[tokens[i]] != 'undefined') 
+		{
+			tokens[i] = elvST[tokens[i]];
+		}
+		translation += tokens[i] + " ";
+	}
+	if (translation && translation != "") return translation;
+	//==================================================================
+
+	if (value_id_assign && value_id_assign != "") return value_id_assign;
+	else                                          return context;
+};
+//<.
--- homematic/WebUI/www/error/error-503.html.orig
+++ homematic/WebUI/www/error/error-503.html
@@ -11,9 +11,14 @@
   </style>
     <script type="text/javascript" src="/webui/js/extern/jquery.js?_version_=2.0pre1"></script>
     <script type="text/javascript" src="/webui/js/extern/jqueryURLPlugin.js?_version_=2.0pre1"></script>
+    <script type="text/javascript" src="/webui/js/lang/loadTextResource.js"></script>
+    <script type="text/javascript" src="/webui/js/lang/translate.js"></script>
+
+    <!--
     <script type="text/javascript" src="/webui/js/lang/translate.lang.js?_version_=2.0pre1"></script>
     <script type="text/javascript" src="/webui/js/lang/translate.lang.extension.js?_version_=2.0pre1"></script>
     <script type="text/javascript" src="/webui/js/lang/translate.js?_version_=2.0pre1"></script>
+    -->
   <script type="text/javascript">
 
     CHECK_INTERVAL = 3000;  // Intervall, in dem geprüft wird, ob der ReGa Webserver aktiv ist
--- homematic/WebUI/www/rega/pages/tabs/admin/msg/timemodule.htm.orig
+++ homematic/WebUI/www/rega/pages/tabs/admin/msg/timemodule.htm
@@ -53,8 +53,6 @@
     </table>
 </div>
 
-<div  class="CLASS05103"><table class="popupTable CLASS05104" border="0"><tr><td>${timeModuleUserHint}</td></tr></table></div>
-
 <div class="CLASS05103">
   <table class="popupTable CLASS05104" border="0" >
     <colgroup>
--- homematic/WebUI/www/tcl/extern/cgi.tcl.orig
+++ homematic/WebUI/www/tcl/extern/cgi.tcl
@@ -2698,7 +2698,7 @@
 # deduce tmp directory
 switch $tcl_platform(platform) {
     unix {
-	set _cgi(tmpdir) /tmp
+	set _cgi(tmpdir) /usr/local/tmp
     } macintosh {
 	set _cgi(tmpdir) [pwd]
     } default {
--- homematic/WebUI/www/tools/devconfig.cgi.orig
+++ homematic/WebUI/www/tools/devconfig.cgi
@@ -139,6 +139,7 @@
         h3 [url "Link List" $env(SCRIPT_NAME)?cmd=list_links&$urlsid]
         h3 [url "Service Messages" $env(SCRIPT_NAME)?cmd=service_messages&$urlsid]
         h3 [url "RSSI" $env(SCRIPT_NAME)?cmd=show_rssi&$urlsid]
+        h3 [url "Device Types" /tools/devicetypes.html]
     }
 }
 
--- homematic/WebUI/www/webui/js/lang/de/translate.lang.extension.js.orig
+++ homematic/WebUI/www/webui/js/lang/de/translate.lang.extension.js
@@ -333,6 +333,8 @@
     "dialogSettingsSecurityMessagePerformSystemResetContent" : "Best&auml;tigen Sie hier, um den System-Reset durchzuf&uuml;hren.<br/><br>Die " + HMIdentifier.de.CCUShortName + " wird automatisch neu gestartet. Danach k&ouml;nnen Sie sich wieder anmelden.",
     "dialogPerformRebootTitle" : "Neustart der Zentrale",
     "dialogPerformRebootContent" : "Der Neustart wird jetzt durchgef&uuml;hrt. Sie k&ouml;nnen sich danach &uuml;ber die Schaltfl&auml;che unten neu anmelden.",
+    "dialogPerformShutdownTitle" : "Herunterfahren der Zentrale",
+    "dialogPerformShutdownContent" : "Die Zentrale wird jetzt heruntergefahren. Bitte warten Sie bis diese komplett heruntergefahren ist und trennen Sie sie erst dann von ihrer Stromquelle.",
     "dialogSetSecKeyRebootHead" : "Bitte geben Sie den Sicherheitsschl&uuml;ssel ein und f&uuml;hren Sie anschlie&szlig;end den Systemreset durch.",
     "dialogSetSecKeyRebootLbl" : "Sicherheitsschl&uuml;ssel: ",
     "dialogSetSecKeyRebootFalseTitle" : "System-Reset: Sicherheitsfehler",
@@ -942,4 +944,4 @@
 
     "theEnd" : ""
   }
-});
\ No newline at end of file
+});
--- homematic/WebUI/www/webui/js/lang/de/translate.lang.js.orig
+++ homematic/WebUI/www/webui/js/lang/de/translate.lang.js
@@ -1,8 +1,8 @@
 jQuery.extend(true,HMIdentifier , {
   "de" : {
-    "CCUFullNameHeader" : "HomeMatic CCU2",
-    "CCUFullNameText" : "Homematic CCU2",
-    "CCUShortName" : "CCU2",
+    "CCUFullNameHeader" : "RaspberryMatic",
+    "CCUFullNameText" : "RaspberryMatic",
+    "CCUShortName" : "RaspMatic",
     "BidCosRF" : "BidCos-RF",
     "BidCosWired" : "BidCos-Wired",
     "VirtualDevices" : "VirtualDevices",
@@ -388,6 +388,7 @@
     "dialogQuestionRemoveCFG" : "M%F6chten Sie den " + HMIdentifier.de.HomeMaticCFGAdapter + " wirklich l%F6schen?",
     "dialogQuestionRemoveExtraSoftware" : "Wollen Sie die Zusatzsoftware wirklich entfernen?",
     "dialogQuestionRestart" : "Best%E4tigen Sie hier, um den Neustart durchzuf%FChren.",
+    "dialogQuestionShutdown" : "Best%E4tigen Sie hier, um das Herunterfahren durchzuf%FChren.",
     "dialogQuestionRestartSafeMode" : "M%F6chten Sie die " + HMIdentifier.de.CCUFullNameText + " wirklich im abgesicherten Modus starten?",
     "dialogUserAccountTitle" : "Benutzerkonto - Konfiguration",
     "dialogProgChoseSysVar" : "Programme - Systemvariablenauswahl",
@@ -413,6 +414,7 @@
     "dialogRestartSafeModeTitle" : "Neustart",
     "dialogRestartSafeModeContent" : "Die Zentrale startet nun im abgesicherten Modus. Klicken Sie auf \"OK\", um sich neu anzumelden.",
     "dialogBtnPerformRestart" : "Neustart ",
+    "dialogBtnPerformShutdown" : "Herunterfahren",
     "dialogEditRoomBtnClose" : "Schliessen",
     "dialogEditRoomBtnNew" : "Neu",
     "infoLoadConfigData" : "Konfigurationsdaten werden geladen...",
@@ -443,6 +445,7 @@
     "dialogSettingsCMTitle" : HMIdentifier.de.CCUShortName + "-Wartung",
     "dialogSettingsCMTDCCUSoftware" : HMIdentifier.de.CCUShortName + "<br/>Software",
     "dialogSettingsCMTDCCURestart" : HMIdentifier.de.CCUShortName + "<br/>Neustart",
+    "dialogSettingsCMTDCCUShutdown" : "Herunterfahren",
     "dialogSettingsCMTDCCUSafeMode" : "Abgesicherter<br/>Modus",
     "dialogSettingsCMTDErrorProtocol" : "Fehler-<br/>protokoll",
     "dialogSettingsCMLblActualSoftwareVersion" : "Aktuelle Software-Version:",
@@ -460,6 +463,7 @@
     "dialogSettingsCMBtnPerformSoftwareUpdateDownload" : "Herunterladen",
     "dialogSettingsCMBtnPerformSoftwareUpdateUpload" : "Hochladen",
     "dialogSettingsCMBtnCCURestart" : "Neustart",
+    "dialogSettingsCMBtnCCUShutdown" : "Herunterfahren",
     "dialogSettingsCMBtnCCURestartSafe" : "Neustart im abgesicherten Modus",
     "dialogSettingsCMBtnLogSysLogServerAddress" : "Einstellungen %FCbernehmen",
     "dialogSettingsCMBtnLogLoadLogFile" : "Logdatei herunterladen",
@@ -470,7 +474,9 @@
     "dialogSettingsCMHintSoftwareUpdate3" : "F%FChren Sie vor dem Update eine Datensicherung durch.",
     "dialogSettingsCMHintSoftwareUpdate4a" : "Der Ladezustand der Batterien betr%E4gt nur noch ",
     "dialogSettingsCMHintSoftwareUpdate4b" : "Um einem Datenverlust durch Ausfall der Stromversorgung vorzubeugen, empfehlen wir, die Batterien vor dem Update zu erneuern.",
+    "dialogSettingsCMHintSoftwareUpdateRaspMatic" : "RaspberryMatic ist ein gemeinschaftliches Projekt. Wenn Sie die Weiterentwicklung gerne in Form einer Geldspende unterst%FCtzen wollen k%F6nen Sie das gerne mittels einer <a href='https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=RAQSDY9YNZVCL' target='_blank'>PayPal Spende</a> tun.<br><br><a href='https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=RAQSDY9YNZVCL' target='_blank'><img alt='PayPal' border=0 src='https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif'></a>",
     "dialogSettingsCMHintRestart" : "Zentrale neu starten. Ver%E4nderte Einstellungen werden vorher gespeichert.",
+    "dialogSettingsCMHintShutdown" : "Zentrale herunterfahren. Ver%E4nderte Einstellungen werden vorher gespeichert.",
     "dialogSettingsCMHintRestartSafeMode" : "HomeMatic Zentrale einmalig im abgesicherten Modus starten. Im abgesicherten Modus wird die installierte Zusatzsoftware nicht gestartet. Ver%E4nderte Einstellungen werden vorher gespeichert.",
     "dialogSettingsCMHintErrorLog" : "Stellen Sie die Anzahl der Logmeldungen ein, die von der Zentrale generiert werden sollen.<br>Sie k%F6nnen zus%E4tzlich einen Rechner angeben, dem die Zentrale ihre Logmeldungen per Syslog schickt. Auf diesem Rechner mu%DF entsprechende Software installiert sein, die die Meldungen entgegennimmt.<br>Zu Diagnosezwecken k%F6nnen die aktuellen Logmeldungen der Zentrale in einer Textdatei heruntergeladen werden.",
     "dialogSettingsCMLogLevel0" : "Alles loggen",
--- homematic/WebUI/www/webui/js/lang/en/translate.lang.extension.js.orig
+++ homematic/WebUI/www/webui/js/lang/en/translate.lang.extension.js
@@ -333,6 +333,8 @@
     "dialogSettingsSecurityMessagePerformSystemResetContent" : "Please confirm here to start the system reset.<br/><br>The " + HMIdentifier.en.CCUShortName + " will be restarted automatically. Afterwards, you can log in again.",
     "dialogPerformRebootTitle" : "Restart of CCU",
     "dialogPerformRebootContent" : "The restart will be performed. Afterwards, you can log in again with the button below.",
+    "dialogPerformShutdownTitle" : "Shutdown of CCU",
+    "dialogPerformShutdownContent" : "The shutdown will be performed. Please wait until the shutdown is finished before you disconnect your CCU from power.",
     "dialogSetSecKeyRebootHead" : "Please enter the security key and perform the system reset afterwards.",
     "dialogSetSecKeyRebootLbl" : "Security key: ",
     "dialogSetSecKeyRebootFalseTitle" : "System reset: Security error",
@@ -940,4 +942,4 @@
 
     "theEnd" : ""
   }
-});
\ No newline at end of file
+});
--- homematic/WebUI/www/webui/js/lang/en/translate.lang.js.orig
+++ homematic/WebUI/www/webui/js/lang/en/translate.lang.js
@@ -1,8 +1,8 @@
 jQuery.extend(true,HMIdentifier , {
   "en" : {
-    "CCUFullNameHeader" : "HomeMatic CCU2",
-    "CCUFullNameText" : "Homematic CCU",
-    "CCUShortName" : "CCU",
+    "CCUFullNameHeader" : "RaspberryMatic",
+    "CCUFullNameText" : "RaspberryMatic",
+    "CCUShortName" : "RaspMatic",
     "BidCosRF" : "BidCos-RF",
     "BidCosWired" : "BidCos-Wired",
     "HmIPRF" : "HmIP-RF",
@@ -388,6 +388,7 @@
     "dialogQuestionRemoveCFG" : "Do you really want to delete the " + HMIdentifier.en.HomeMaticCFGAdapter + "?",
     "dialogQuestionRemoveExtraSoftware" : "Do you really want to delete the additional software?",
     "dialogQuestionRestart" : "Please click here to perform the restart?",
+    "dialogQuestionShutdown" : "Please click here to perform the shutdown?",
     "dialogQuestionRestartSafeMode" : "Do you really want to start the " + HMIdentifier.en.CCUFullNameText + " in the safe mode?",
     "dialogUserAccountTitle" : "User account configuration",
     "dialogProgChoseSysVar" : "Programs - system variable selection",
@@ -413,6 +414,7 @@
     "dialogRestartSafeModeTitle" : "Restart",
     "dialogRestartSafeModeContent" : "The Central Control Unit will now start in safe mode. Please click \"OK\" to log in again.",
     "dialogBtnPerformRestart" : "Restart ",
+    "dialogBtnPerformShutdown" : "Shutdown",
     "dialogEditRoomBtnClose" : "Close",
     "dialogEditRoomBtnNew" : "New",
     "infoLoadConfigData" : "Loading configuration data",
@@ -443,6 +445,7 @@
     "dialogSettingsCMTitle" : HMIdentifier.en.CCUShortName + " maintenance",
     "dialogSettingsCMTDCCUSoftware" : HMIdentifier.en.CCUShortName + "<br/>software",
     "dialogSettingsCMTDCCURestart" : HMIdentifier.en.CCUShortName + "<br/>restart",
+    "dialogSettingsCMTDCCUShutdown" : "Shutdown",
     "dialogSettingsCMTDCCUSafeMode" : "Safe<br/>mode",
     "dialogSettingsCMTDErrorProtocol" : "Error<br/>log",
     "dialogSettingsCMLblActualSoftwareVersion" : "Current software version:",
@@ -460,6 +463,7 @@
     "dialogSettingsCMBtnPerformSoftwareUpdateDownload" : "Download",
     "dialogSettingsCMBtnPerformSoftwareUpdateUpload" : "Upload",
     "dialogSettingsCMBtnCCURestart" : "Restart",
+    "dialogSettingsCMBtnCCUShutdown" : "Shutdown",
     "dialogSettingsCMBtnCCURestartSafe" : "Restart in safe mode",
     "dialogSettingsCMBtnLogSysLogServerAddress" : "Apply settings",
     "dialogSettingsCMBtnLogLoadLogFile" : "Download log file",
@@ -470,7 +474,9 @@
     "dialogSettingsCMHintSoftwareUpdate3" : "Please perform a data backup before starting the update.",
     "dialogSettingsCMHintSoftwareUpdate4a" : "The charging status the batteries is only at ",
     "dialogSettingsCMHintSoftwareUpdate4b" : "To prevent from data loss due to power failure, it is recommended to replace the batteries before starting the update.",
+    "dialogSettingsCMHintSoftwareUpdateRaspMatic" : "RaspberryMatic is a community driven project. If you want to support it, please consider a <a href='https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=RAQSDY9YNZVCL' target='_blank'>PayPal donation</a> to support further development.<br><br><a href='https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=RAQSDY9YNZVCL' target='_blank'><img alt='PayPal' border=0 src='https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif'></a>",
     "dialogSettingsCMHintRestart" : "Restart CCU. The changed settings will be saved before.",
+    "dialogSettingsCMHintShutdown" : "Shutdown CCU. The changed settings will be saved before.",
     "dialogSettingsCMHintRestartSafeMode" : "Start HomeMatic Central Control Unit in safe mode once. In safe mode, the installed additional software will not be started. The changed settings will be saved before.",
     "dialogSettingsCMHintErrorLog" : "Please set the number of log messages to be generated by the CCU.<br>You can also specify a computer that will receive the log messages from the CCU via syslog. An additional software that will be able to receive this messages has to be installed on the computer.<br>To analyse the results, the current log messages of the CCU can be downloaded in a text file.",
     "dialogSettingsCMLogLevel0" : "Log all",
--- homematic/WebUI/www/webui/js/lang/tr/translate.lang.extension.js.orig
+++ homematic/WebUI/www/webui/js/lang/tr/translate.lang.extension.js
@@ -332,6 +332,8 @@
     "profileNotSaveable" : "Bu profil, profil taslagi olarak kaydedilemez.",
     "dialogPerformRebootTitle" : "Merkezi yeniden baslat",
     "dialogPerformRebootContent" : "Yeniden baslatma islemi simdi gerceklestiriliyor. Daha sonra alt kisimdaki alandan yeniden oturum acabilirsiniz.",
+    "dialogPerformShutdownTitle" : "Shutdown of CCU",
+    "dialogPerformShutdownContent" : "The shutdown will be performed. Please wait until the shutdown is finished before you disconnect your CCU from power.",
     "dialogSetSecKeyRebootHead" : "L%FCtfen g%FCvenlik kodunu girin ve daha sonra sistemi yeniden baslatin.",
     "dialogSetSecKeyRebootLbl" : "G%FCvenlik kodu: ",
     "dialogSetSecKeyRebootFalseTitle" : "Sistemi yeniden baslat: G%FCvenlik hatasi",
@@ -935,4 +937,4 @@
 
     "theEnd" : ""
   }
-});
\ No newline at end of file
+});
--- homematic/WebUI/www/webui/js/lang/tr/translate.lang.js.orig
+++ homematic/WebUI/www/webui/js/lang/tr/translate.lang.js
@@ -1,8 +1,8 @@
 jQuery.extend(true,HMIdentifier , {
   "tr" : {
-    "CCUFullNameHeader" : "HomeMatic CCU2",
-    "CCUFullNameText" : "Homematic CCU",
-    "CCUShortName" : "CCU",
+    "CCUFullNameHeader" : "RaspberryMatic",
+    "CCUFullNameText" : "RaspberryMatic",
+    "CCUShortName" : "RaspMatic",
     "BidCosRF" : "BidCos-RF",
     "BidCosWired" : "BidCos-Wired",
     "HmIPRF" : "HmIP-RF",
@@ -390,6 +390,7 @@
     "dialogQuestionRemoveCFG" : HMIdentifier.tr.HomeMaticCFGAdapter + " gercekten silmek istiyor musunuz?",
     "dialogQuestionRemoveExtraSoftware" : "Ek yazilimi gercekten kaldirmak istiyor musunuz?",
     "dialogQuestionRestart" : "Sistemi yeniden baslatmak icin buradan onaylayin.",
+    "dialogQuestionShutdown" : "Please click here to perform the shutdown?",
     "dialogQuestionRestartSafeMode" : HMIdentifier.tr.CCUFullNameText + "'yi gercekten g%FCvenli modda baslatmak istiyor musunuz?",
     "dialogUserAccountTitle" : "Kullanici hesabi konfig%FCrasyonu",
     "dialogProgChoseSysVar" : "Programlar - sistem degiskeni sec",
@@ -415,6 +416,7 @@
     "dialogRestartSafeModeTitle" : "Yeniden baslat",
     "dialogRestartSafeModeContent" : "Merkez sadece g%FCvenli modda baslar. Yeniden oturum acmak icin \"OK\"'e tiklayin.",
     "dialogBtnPerformRestart" : "Yeniden baslat ",
+    "dialogBtnPerformShutdown" : "Shutdown",
     "dialogEditRoomBtnClose" : "Kapat",
     "dialogEditRoomBtnNew" : "Yeni",
     "infoLoadConfigData" : "Konfig%FCrasyon bilgileri y%FCkleniyor...",
@@ -472,7 +474,9 @@
     "dialogSettingsCMHintSoftwareUpdate3" : "G%FCncellemeden %F6nce verileri emniyete alin.",
     "dialogSettingsCMHintSoftwareUpdate4a" : "Bataryalarin sarj durumu artik sadece ",
     "dialogSettingsCMHintSoftwareUpdate4b" : "Elektrik kesintisi nedeniyle veri kaybini %F6nlemek icin bataryalari g%FCncellemeyi baslatmadan %F6nce degistirmenizi %F6neriyoruz.",
+    "dialogSettingsCMHintSoftwareUpdateRaspMatic" : "RaspberryMatic is a community driven project. If you want to support it, please consider a <a href='https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=RAQSDY9YNZVCL' target='_blank'>PayPal donation</a> to support further development.<br><br><a href='https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=RAQSDY9YNZVCL' target='_blank'><img alt='PayPal' border=0 src='https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif'></a>",
     "dialogSettingsCMHintRestart" : "Merkezi yeniden baslat. Degistirilmis ayarlar %F6nceden kaydedilir.",
+    "dialogSettingsCMHintShutdown" : "Shutdown CCU. The changed settings will be saved before.",
     "dialogSettingsCMHintRestartSafeMode" : "HomeMatic merkezini bir kere g%FCvenli modda baslatin. G%FCvenli modda y%FCklenen ek yazilim baslatilmaz. Degistirilmis ayarlar %F6nceden kaydedilir.",
     "dialogSettingsCMHintErrorLog" : "Merkez tarafindan olusturulacak Log bildiri sayisini ayarlayin.<br>Buna ek olarak merkezin Log bildirilerini Syslog'u kullanarak iletecegi baska bir bilgisayar tanimlayabilirsiniz. Bu bilgisayar %FCzerinde bildirileri alacak uygun bir yazilim y%FCkl%FC olmalidir.<br>Merkezin g%FCncel Log bildirileri teshis amaciyla bir metin dosyasi seklinde indirilebilir.",
     "dialogSettingsCMLogLevel0" : "Her seyi Log'lara gecir",
--- homematic/WebUI/www/webui/webui.js.orig
+++ homematic/WebUI/www/webui/webui.js
@@ -11423,8 +11423,9 @@
     var isOk = true;
     for (var i = 0, len = ips.length; i < len; i++) {
       var ip = ips[i];
-      if (!ip.match(/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(\/[0-9]+)?$/)) {
+      if (!ip.match(/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(\/[0-9]+)?$/) && !ip.match(/^[a-f0-9]+:/)) {
         isOk = false;
+        break;
       }
     }
 
@@ -18284,7 +18285,7 @@
     var script = document.createElement("script");
     script.id = "homematic_com_script";
     script.type = "text/javascript";
-    script.src = "http://update.homematic.com/firmware/download?cmd=js_check_version&version="+WEBUI_VERSION+"&product=HM-CCU2&serial=" + serial;
+    script.src = "https://gitcdn.xyz/repo/jens-maus/RaspberryMatic/master/release/LATEST-VERSION.js"
     $("body").appendChild(script);
   },
 
@@ -18380,7 +18381,7 @@
    **/
   setLatestVersion: function(latestVersion, product)
   {
-    if (product == "HM-CCU2") {
+    if (product == "HM-RASPBERRYMATIC") {
       homematic.com.m_latestVersion = latestVersion;
       homematic.com.m_isUpdateAvailable = (WEBUI_VERSION != latestVersion);
     } else {
